function d(l,e=document){return e.querySelector(l)}function h(l,e=document){return Array.from(e.querySelectorAll(l))}function p(l){var e;return l&&((e=l.textContent)==null?void 0:e.trim())||""}class m{constructor(){this.source="chatgpt"}canScrape(){const e=window.location.hostname;return e==="chatgpt.com"||e==="chat.openai.com"}scrapeCurrentConversation(){try{const e=this.extractMessages();return e.length===0?(console.warn("[Breadcrumps] No messages found on ChatGPT page"),null):{title:this.extractTitle(),source:"chatgpt",source_url:window.location.href,messages:e,scraped_at:new Date().toISOString(),metadata:{model:this.detectModel()}}}catch(e){return console.error("[Breadcrumps] ChatGPT scraping error:",e),null}}extractMessages(){const e=[],r=h("[data-message-author-role]");if(r.length>0){for(const t of r){const a=t.getAttribute("data-message-author-role");if(a!=="user"&&a!=="assistant")continue;const n=t.querySelector(".markdown")||t.querySelector(".whitespace-pre-wrap")||t.querySelector("[data-message-id]")||t,c=this.cleanContent(n);c&&e.push({role:a,content:c})}if(e.length>0)return e}const o=h('div[data-testid^="conversation-turn-"]');if(o.length>0){for(const t of o){const a=t.querySelector('[data-message-author-role="user"]'),n=t.querySelector('[data-message-author-role="assistant"]'),c=t.querySelector(".markdown")||t.querySelector(".whitespace-pre-wrap")||t,i=this.cleanContent(c);i&&e.push({role:a?"user":n?"assistant":"user",content:i})}if(e.length>0)return e}console.warn("[Breadcrumps] Using fallback scraping strategy for ChatGPT");const s=h(".markdown.prose, .whitespace-pre-wrap");for(let t=0;t<s.length;t++){const a=this.cleanContent(s[t]);a&&e.push({role:t%2===0?"user":"assistant",content:a})}return e}extractTitle(){var s;const e=(s=document.title)==null?void 0:s.replace(" | ChatGPT","").replace("ChatGPT","").trim();if(e&&e.length>0&&e!=="ChatGPT")return e;const r=d('nav a[aria-current="page"]')||d("nav .bg-token-sidebar-surface-secondary");if(r){const t=p(r);if(t)return t}const o=d('[data-message-author-role="user"]');if(o){const t=p(o);return t.substring(0,80)+(t.length>80?"...":"")}return"Untitled ChatGPT Conversation"}detectModel(){const e=d('[data-testid="model-selector"]')||d('button[aria-label*="Model"]')||d("span.text-token-text-secondary");if(e){const r=p(e).toLowerCase();if(r.includes("4o"))return"gpt-4o";if(r.includes("4"))return"gpt-4";if(r.includes("3.5"))return"gpt-3.5-turbo";if(r.includes("o1"))return"o1";if(r.includes("o3"))return"o3"}}cleanContent(e){if(!e)return"";let r="";const o=s=>{if(s.nodeType===Node.TEXT_NODE)r+=s.textContent;else if(s.nodeType===Node.ELEMENT_NODE){const t=s.tagName.toLowerCase();t==="pre"||t==="code"?r+="\n```\n"+s.textContent+"\n```\n":t==="br"?r+=`
`:t==="p"||t==="div"||t==="li"?(r+=`
`,s.childNodes.forEach(o),r+=`
`):s.childNodes.forEach(o)}};return e.childNodes.forEach(o),r.replace(/\n{3,}/g,`

`).trim()}}class C{constructor(){this.source="claude"}canScrape(){return window.location.hostname==="claude.ai"}scrapeCurrentConversation(){try{const e=this.extractMessages();return e.length===0?(console.warn("[Breadcrumps] No messages found on Claude page"),null):{title:this.extractTitle(),source:"claude",source_url:window.location.href,messages:e,scraped_at:new Date().toISOString(),metadata:{model:this.detectModel()}}}catch(e){return console.error("[Breadcrumps] Claude scraping error:",e),null}}extractMessages(){const e=[],r=h('[data-testid="user-message"]'),o=h("[data-is-streaming]");if(r.length===0&&o.length===0)return this.fallbackExtract();const s=[];for(const t of r)s.push({el:t,role:"user"});for(const t of o){const a=t.querySelector(".font-claude-response")||t;s.push({el:a,role:"assistant"})}s.sort((t,a)=>{const n=t.el.compareDocumentPosition(a.el);return n&Node.DOCUMENT_POSITION_FOLLOWING?-1:n&Node.DOCUMENT_POSITION_PRECEDING?1:0});for(const{el:t,role:a}of s){const n=a==="assistant"?this.cleanAssistantContent(t):this.cleanContent(t);if(!n||n.length<2)continue;const c=e[e.length-1];c&&c.role===a&&c.content===n||e.push({role:a,content:n})}return e}fallbackExtract(){console.warn("[Breadcrumps] Using fallback extraction");const e=[],r=h('[data-testid="user-message"]'),o=h(".font-claude-response");if(r.length===0&&o.length===0)return e;const s=[];for(const t of r)s.push({el:t,role:"user"});for(const t of o)s.push({el:t,role:"assistant"});s.sort((t,a)=>{const n=t.el.compareDocumentPosition(a.el);return n&Node.DOCUMENT_POSITION_FOLLOWING?-1:n&Node.DOCUMENT_POSITION_PRECEDING?1:0});for(const{el:t,role:a}of s){const n=a==="assistant"?this.cleanAssistantContent(t):this.cleanContent(t);if(!n||n.length<2)continue;const c=e[e.length-1];c&&c.role===a&&c.content===n||e.push({role:a,content:n})}return e}cleanAssistantContent(e){if(!e)return"";const r=[],o=new Set,s=(t,a=0)=>{if(!(a>50)){if(t.nodeType===Node.ELEMENT_NODE){const n=t;if(o.has(n))return;const c=n.tagName.toLowerCase();if(c==="button"||c==="svg"||c==="style"||c==="script"||n.getAttribute("aria-hidden")==="true"||n.classList.contains("bg-gradient-to-t")||n.querySelector('button[aria-label*="Copy"]')&&!n.querySelector("pre"))return;if(c==="p"){o.add(n);const i=this.getTextContent(n);i.trim()&&r.push(i.trim());return}if(c==="h1"||c==="h2"||c==="h3"||c==="h4"||c==="h5"||c==="h6"){o.add(n);const i=this.getTextContent(n);i.trim()&&r.push(`
## ${i.trim()}`);return}if(c==="ol"){o.add(n);const i=n.querySelectorAll(":scope > li");if(i.length>0){i.forEach((u,f)=>{o.add(u);const g=this.getTextContent(u);g.trim()&&r.push(`${f+1}. ${g.trim()}`)});return}}if(c==="ul"){o.add(n);const i=n.querySelectorAll(":scope > li");if(i.length>0){i.forEach(u=>{o.add(u);const f=this.getTextContent(u);f.trim()&&r.push(`- ${f.trim()}`)});return}}if(c==="pre"){o.add(n);const u=(n.querySelector("code")||n).textContent||"";u.trim()&&r.push("```\n"+u.trim()+"\n```");return}if(c==="div"&&n.querySelector("pre")){o.add(n);const i=n.querySelector("pre");if(i){const f=(i.querySelector("code")||i).textContent||"";f.trim()&&r.push("```\n"+f.trim()+"\n```")}return}if(c==="blockquote"){o.add(n);const i=this.getTextContent(n);i.trim()&&r.push("> "+i.trim().replace(/\n/g,`
> `));return}n.childNodes.forEach(i=>s(i,a+1))}else if(t.nodeType===Node.TEXT_NODE){const n=(t.textContent||"").trim();if(n&&n.length>0){const c=t.parentElement;c&&!o.has(c)&&r.push(n)}}}};return e.childNodes.forEach(t=>s(t,0)),r.join(`

`).replace(/\n{3,}/g,`

`).trim()}getTextContent(e){let r="";const o=s=>{var t;if(s.nodeType===Node.TEXT_NODE)r+=s.textContent||"";else if(s.nodeType===Node.ELEMENT_NODE){const a=s,n=a.tagName.toLowerCase();if(n==="button"||n==="svg")return;n==="code"?((t=a.parentElement)==null?void 0:t.tagName.toLowerCase())!=="pre"?r+="`"+(a.textContent||"")+"`":r+=a.textContent||"":n==="strong"||n==="b"?(r+="**",a.childNodes.forEach(o),r+="**"):n==="em"||n==="i"?(r+="*",a.childNodes.forEach(o),r+="*"):n==="br"?r+=`
`:a.childNodes.forEach(o)}};return e.childNodes.forEach(o),r}cleanContent(e){return e?this.getTextContent(e).replace(/\n{3,}/g,`

`).replace(/[ \t]+/g," ").trim():""}extractTitle(){var o;const e=(o=document.title)==null?void 0:o.replace(/\s*[-â€“]\s*Claude\s*$/,"").trim();if(e&&e.length>0&&e!=="Claude")return e;const r=d('a[aria-current="page"]');if(r){const s=p(r);if(s)return s}return"Untitled Claude Conversation"}detectModel(){const e=d('[data-testid="model-selector"]')||d('button[aria-label*="Model"]');if(e){const r=p(e).toLowerCase();if(r.includes("opus"))return"claude-opus";if(r.includes("sonnet"))return"claude-sonnet";if(r.includes("haiku"))return"claude-haiku"}}}const E=[new m,new C];function N(){for(const l of E)if(l.canScrape())return console.log(`[Breadcrumps] Detected site: ${l.source}`),l;return console.log("[Breadcrumps] No supported AI chat site detected"),null}console.log("[Breadcrumps] Content script loaded on",window.location.hostname);chrome.runtime.onMessage.addListener((l,e,r)=>{if(l.type==="SCRAPE_CONVERSATION"){console.log("[Breadcrumps] Scrape request received");const o=N();if(!o)return r({success:!1,error:"This site is not supported. Open ChatGPT or Claude."}),!0;try{const s=o.scrapeCurrentConversation();if(!s||s.messages.length===0)return r({success:!1,error:"No conversation found on this page. Make sure a conversation is open."}),!0;console.log(`[Breadcrumps] Scraped ${s.messages.length} messages from ${s.source}`),r({success:!0,conversation:s})}catch(s){console.error("[Breadcrumps] Scraping failed:",s),r({success:!1,error:`Scraping failed: ${s.message}`})}return!0}if(l.type==="PING")return r({alive:!0,site:window.location.hostname}),!0});
